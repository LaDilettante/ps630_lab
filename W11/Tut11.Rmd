---
title: "Tutorial 11: Simulations"
author: "Jan Vogler (jan.vogler@duke.edu)"
date: "November 6, 2015"
output: pdf_document
---

# Today's Agenda

1. Model simulations
2. Using model simulations to make predictions
3. Estimating interaction effects through simulations

**Credit to Professor Chris Johnston. The code for the simulation approach introduced here is from his class.**



# 1. Model simulations

We will look at data from a data set that we have not used previously, data on attitudes toward the United States Supreme Court.

```{r,tidy=TRUE}
setwd("C:/Users/Jan/OneDrive/Documents/GitHub/ps630_lab/w11/")
courtdata <- read.table("courtdata.txt", header=TRUE)
summary(courtdata)
```

What is the meaning of the variables in the data set?

## Independent Variables

college = dummy for college education

ideo = 5-point ideological self-identification, ranging from "very liberal" to "very conservative"

soph = 10-item political knowledge scale

black, hispanic = dummies for respective categories

income = 15-point household income category scale

ruling = dummy indicating respondent correctly identified the Affordable Care Act ruling

male = dummy indicating male gender

## Dependent Variable

We are interested in attitudes of US citizens toward the Supreme Court. For this purpose we look at the variable "sclaw" ("Supreme Court Law"). The variable was based on the following statement:

"The Supreme Court should be allowed to throw out any law it deems unconstitutional"

The variable ranges from "strongly agree" to "strongly disagree".

Let us estimate a linear model.

```{r,tidy=TRUE}
model1 <- lm(sclaw ~ ruling + ideo + soph + age + male + black + hisp + college + income, data=courtdata)
summary(model1)
```

When we estimate a linear model, all our coefficients are assumed to be normally distributed random variables with a mean and a variance that depends on the data. We can make use of this fact by simulating different versions of the model.

For the simulations we need the package "arm". Please make sure to install it via the following command: install.packages("arm")

```{r,tidy=TRUE}
library(arm)
model1.sims <- sim(model1, n.sims=1000)
```



# 2. Using model simulations to make predictions

The following plot is generated by our knowledge about the regression. We access the first coefficient (the intercept) and the third coefficient (ideology). We let ideology vary from 1 to 5. If we plug in the right formula, then we will get the predicted values when all other variables are at the value 0.

```{r,tidy=TRUE}
curve(coef(model1)[1] + coef(model1)[3]*x, from=1, to=5, 
	ylim=c(1,5), xlab="Conservatism", ylab="Opposition to Judicial Review", 
	main="Opposition to Judicial Review as a Function of Ideology", lwd=2)
```

Now let's look instead at the lines that are the result of the 1000 simulations that we created above.

```{r,tidy=TRUE}
curve(coef(model1)[1] + coef(model1)[3]*x, from=1, to=5, 
	ylim=c(1,5), xlab="Conservatism", ylab="Opposition to Judicial Review", 
	main="Opposition to Judicial Review as a Function of Ideology", lwd=2)
for (i in 1:1000){
	curve(coef(model1.sims)[i,1] + coef(model1.sims)[i,3]*x, add=TRUE, col="gray80")
}
```

What we can see in this plot is that the simulated coefficients are very similar to the one that we already had. In fact, the simulation predictions are approximately normally distributed around our original regression line.

Let's run the original command one more time, so we get our regression line back.

```{r,tidy=TRUE}
curve(coef(model1)[1] + coef(model1)[3]*x, from=1, to=5, 
	ylim=c(1,5), xlab="Conservatism", ylab="Opposition to Judicial Review", 
	main="Opposition to Judicial Review as a Function of Ideology", lwd=2)

curve(coef(model1)[1] + coef(model1)[3]*x, from=1, to=5, 
	ylim=c(1,5), xlab="Conservatism", ylab="Opposition to Judicial Review", 
	main="Opposition to Judicial Review as a Function of Ideology", lwd=2)
for (i in 1:1000){
	curve(coef(model1.sims)[i,1] + coef(model1.sims)[i,3]*x, add=TRUE, col="gray80")
}

curve(coef(model1)[1] + coef(model1)[3]*x, col="black", lwd=2, add=TRUE)
```

Let us now take our model simulations into account. They can help us to make an average predictive comparison. We use our model simulations in combination with draws from the data to create a so-called "average predictive comparison".

```{r,tidy=TRUE}
#Using simulation to get CIs for average predictive comparisons
#Create a matrix and a vector to be filled with (1) 1000 simulations of change in predicted prob, 1 for each obs, and (2) 1000 simulations of AVP

# Remember, these were the variables from our regression: (intercept) + ruling + ideo + soph + age + male + black + hisp + college + income

summary(courtdata$ideo)

d.ideo <- array(NA, c(1000,length(courtdata$sclaw)))
m.ideo <- array(NA, 1000)

for (i in 1:1000){
	d.ideo[i, ] <- (coef(model1.sims)[i,1] + coef(model1.sims)[i,2]*courtdata$ruling + coef(model1.sims)[i,3]*5 +
		coef(model1.sims)[i,4]*courtdata$soph + coef(model1.sims)[i,5]*courtdata$age + coef(model1.sims)[i,6]*courtdata$male
		+ coef(model1.sims)[i,7]*courtdata$black + coef(model1.sims)[i,8]*courtdata$hisp +
		  coef(model1.sims)[i,9]*courtdata$college + coef(model1.sims)[i,10]*courtdata$income) -
	    (coef(model1.sims)[i,1] + coef(model1.sims)[i,2]*courtdata$ruling + coef(model1.sims)[i,3]*0 +
		coef(model1.sims)[i,4]*courtdata$soph + coef(model1.sims)[i,5]*courtdata$age + coef(model1.sims)[i,6]*courtdata$male
		+ coef(model1.sims)[i,7]*courtdata$black + coef(model1.sims)[i,8]*courtdata$hisp +
		  coef(model1.sims)[i,9]*courtdata$college + coef(model1.sims)[i,10]*courtdata$income)
	m.ideo[i] <- mean(d.ideo[i, ])
}

mean(m.ideo)
sd(m.ideo)
quantile(m.ideo, probs=c(.025,.16,.84,.975))
```

Let's compare this to the effect that sophistication has.

```{r,tidy=TRUE}
summary(courtdata$soph)

d.soph <- array(NA, c(1000,length(courtdata$sclaw)))
m.soph <- array(NA, 1000)

for (i in 1:1000){
	d.soph[i, ] <- ((coef(model1.sims)[i,1] + coef(model1.sims)[i,2]*courtdata$ruling + coef(model1.sims)[i,3]*courtdata$ideo +
		coef(model1.sims)[i,4]*10 + coef(model1.sims)[i,5]*courtdata$age + coef(model1.sims)[i,6]*courtdata$male
		+ coef(model1.sims)[i,7]*courtdata$black + coef(model1.sims)[i,8]*courtdata$hisp +
		  coef(model1.sims)[i,9]*courtdata$college + coef(model1.sims)[i,10]*courtdata$income) -
	    (coef(model1.sims)[i,1] + coef(model1.sims)[i,2]*courtdata$ruling + coef(model1.sims)[i,3]*courtdata$ideo +
		coef(model1.sims)[i,4]*0 + coef(model1.sims)[i,5]*courtdata$age + coef(model1.sims)[i,6]*courtdata$male
		+ coef(model1.sims)[i,7]*courtdata$black + coef(model1.sims)[i,8]*courtdata$hisp +
		  coef(model1.sims)[i,9]*courtdata$college + coef(model1.sims)[i,10]*courtdata$income))
	m.soph[i] <- mean(d.soph[i, ])
}

mean(m.soph)
sd(m.soph)
quantile(m.soph, probs=c(.025,.16,.84,.975))
```

Let us plot these two in comparison.

```{r,tidy=TRUE}
plot(1:2, c(mean(m.ideo),mean(m.soph)), type="p", ylim=c(-1.5,0.5), xlab="", 
	main="Ideology, Knowledge, and Attitudes Toward the Supreme Court",
	ylab="Average predictive comparison (2 SD change)", asp=1.5, axes=FALSE)
axis(1, at=c(1,2), labels=c("Ideology","Knowledge"))
axis(2, at=c(-1.5,-1,-.5,0,.5))
abline(h=0, lty=2)
segments(1, quantile(m.ideo, probs=c(.025)), 1, quantile(m.ideo, probs=c(.975)))
segments(2, quantile(m.soph, probs=c(.025)), 2, quantile(m.soph, probs=c(.975)))
```



# 3. Estimating interaction effects through simulations

Let us consider an interaction effect of ideology and political sophistication.

```{r,tidy=TRUE}
model2 <- lm(sclaw ~ ruling + ideo + soph + ideo:soph + age + male + black + hisp + college + income, data=courtdata)
summary(model2)
```

As we can see, there is some statistical evidence for an interaction effect.

Let's plot this interaction effect based on the regression output.

```{r,tidy=TRUE}
curve(coef(model2)[1] + coef(model2)[3]*x + coef(model2)[4]*0 + coef(model2)[11]*x*0, from=1, to=5, 
	ylim=c(1,5), xlab="Conservatism", ylab="Opposition to Judicial Review", 
	main="Opposition to Judicial Review as a Function of Ideology", lwd=2)

curve(coef(model2)[1] + coef(model2)[3]*x + coef(model2)[4]*5 + coef(model2)[11]*x*5, lty=2, lwd=2, add=TRUE)
curve(coef(model2)[1] + coef(model2)[3]*x + coef(model2)[4]*10 + coef(model2)[11]*x*10, lty=3, lwd=2, add=TRUE)

legend("topright", title="Sophistication", c("0","5","10"), lty=c(1,2,3), lwd=c(2,2,2), bty="n", inset=.05)
```

What we can see in the picture is the effect that political ideology has on the opposition to judicial review at different levels of sophistication.

Lets use another approach in which we take mode simulations into account.

```{r,tidy=TRUE}
model2.sims <- sim(model2, n.sims=1000)

#Create blank matrix for ideo beta sims

soph.sims <- matrix(NA, nrow=1000, ncol=11)

#Fill matrix, where each column corresponds with one of the 11 values of soph

for (i in 0:10){
	soph.sims[ ,i+1] <- coef(model2.sims)[ ,3] + coef(model2.sims)[ ,11]*i
}

#Summarize conditional coefficients for ideo

ideo.betas <- matrix(NA, nrow=11, ncol=1)
for (i in 1:11){
	ideo.betas[i, 1] <- mean(soph.sims[ ,i])
}

ideo.ci <- matrix(NA, nrow=11, ncol=4)
for (i in 1:11){
	ideo.ci[i, 1] <- quantile(soph.sims[ ,i], .025)
	ideo.ci[i, 2] <- quantile(soph.sims[ ,i], .975)
	ideo.ci[i, 3] <- quantile(soph.sims[ ,i], .16)
	ideo.ci[i, 4] <- quantile(soph.sims[ ,i], .84)
}

ideo.table <- cbind(ideo.betas, ideo.ci)
ideo.table

```

Let us plot these results.

```{r,tidy=TRUE}
plot(ideo.table[1:11,1], ylim=c(-1,1), axes=FALSE, type="l", col="black", lwd=2, lty=1, xlab="# of Correct Answers", ylab="Marginal Effect of Ideology", 
	main="Conditional Effects of Ideology")
axis(1, at=c(1:11),labels=c(0:10))
axis(2, at=c(-1,-.5,0,.5,1))
lines(c(1:11),rep(0,11))
matlines(1:11, ideo.table[1:11,c(2,3)],col="gray70",lty=2,lwd=2)

plot(c(1:11), c(ideo.table[1:11,1]), axes=FALSE, ylim=c(-1,1), xlab="# of Correct Answers", ylab="Marginal Effect of Ideology", 
	main="Conditional Effects of Ideology")
axis(1, at=c(1:11),labels=c(0:10))
axis(2, at=c(-1,-.5,0,.5,1))
lines(c(1:11),rep(0,11)) 
segments(c(1:11), c(ideo.table[ ,2]), c(1:11), c(ideo.table[ ,3]), lwd=1, lty=2)
segments(c(1:11), c(ideo.table[ ,4]), c(1:11), c(ideo.table[ ,5]), lwd=2, lty=1)
```

More.

```{r,tidy=TRUE}
X.tilde <- cbind(rep(1,5), rep(1,5), seq(1,5,length=5), 
	rep(5,5), rep(30,5), rep(0,5), 
	rep(0,5), rep(0,5), 
	rep(0,5), rep(8,5))

n.tilde <- 5

n.sims <- 1000
sim.model1 <- sim(model1, n.sims)

y.tilde <- array(NA, c(n.sims, n.tilde))

for (i in 1:n.sims){
	y.tilde[i, ] <- rnorm(n.tilde, X.tilde%*%coef(sim.model1)[i, ], 
				sigma.hat(sim.model1)[i])
}


p.ideo <- matrix(NA, nrow=5, ncol=1)
for (i in 1:5){
	p.ideo[i, 1] <- mean(y.tilde[ ,i])
}

p.ideo.ci <- matrix(NA, nrow=5, ncol=4)
for (i in 1:5){
	p.ideo.ci[i, ] <- quantile(y.tilde[ ,i], prob=c(.025,.16,.84,.975))
}

ideo.table <- cbind(p.ideo, p.ideo.ci)
ideo.table
```



## Remember

```{r,tidy=TRUE}
fun=c("R","is","fun")
paste(fun, collapse=" ")
```